<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Lectura Pro v4.2</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Kalam:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora:ital,wght@0,600;0,700;1,500&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f5f5f4; color: #451a03; }
    .card { background: white; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    input, textarea, select { border: 1.5px solid #e7e5e4 !important; border-radius: 14px !important; padding: 12px !important; outline: none !important; }
    .btn-tab-active { background-color: #6b21a8; color: white; font-weight: 800; }
    .btn-tab-inactive { color: #a8a29e; font-weight: 700; }
    .status-toggle { width: 40px; height: 20px; background: #d1d5db; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
    .status-toggle.active { background: #22c55e; }
    .status-toggle::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    .status-toggle.active::after { left: 22px; }
    .badge-grado { cursor: pointer; transition: 0.2s; }
    .badge-grado.selected { background-color: #6b21a8; color: white; border-color: #6b21a8; }

    #modal-preview { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    .preview-device { background: #dff5e1; width: 100%; max-width: 380px; height: 90vh; border-radius: 35px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; position: relative; border: 8px solid #333; }
    .preview-header { background: #1b5e20; color: #fff; padding: 15px; text-align: center; font-weight: 800; font-size: 12px; text-transform: uppercase; border-radius: 0 0 25px 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10; font-family: system-ui, sans-serif; letter-spacing: 1px;}
    .preview-content { padding: 20px; overflow-y: auto; flex: 1; font-family: system-ui, Arial, sans-serif; }
    .preview-content .lectura-texto { background: #fff8e1; padding: 20px; border-radius: 16px; border: 1.5px solid #ffe082; font-family: 'Lora', serif; font-size: 15px; line-height: 1.7; color: #424242; margin-bottom: 25px; box-shadow: inset 0 0 10px rgba(0,0,0,0.02); }
    .preview-content .pregunta-card { background: #f8fafc; padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
    .preview-content .opcion-label { display: block; padding: 12px; background: white; border: 1.5px solid #cbd5e1; border-radius: 12px; margin-top: 8px; font-size: 13px; font-weight: 600; cursor: default; }
    .preview-content .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; width: 100%; overflow: hidden; border-radius: 12px; margin-bottom: 15px; background: #000; }
    .preview-content .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .preview-btn { width: 100%; padding: 15px; background: #0277bd; color: #fff; font-weight: 800; border: none; border-radius: 14px; font-size: 15px; box-shadow: 0 4px 0 #01579b; margin-top: 5px; opacity: 0.6; cursor: not-allowed;}
  </style>
</head>
<body class="p-4 pb-20">

  <div id="modal-preview" onclick="cerrarVistaPrevia()">
      <div class="preview-device" onclick="event.stopPropagation()">
          <div class="preview-header">üì± VISTA PREVIA DEL ESTUDIANTE</div>
          <div class="preview-content" id="preview-body"></div>
          <div style="padding: 15px; text-align: center; background: #fff; border-top: 1px solid #ddd;">
              <button onclick="cerrarVistaPrevia()" class="bg-red-600 text-white font-black uppercase text-[10px] px-6 py-3 rounded-xl shadow-lg active:scale-95 transition-all">‚úñ CERRAR SIMULADOR</button>
          </div>
      </div>
  </div>

  <header class="max-w-4xl mx-auto mb-6 text-center">
    <h1 class="text-2xl font-black uppercase text-purple-900 tracking-tighter">Panel de Lectura Pro <span class="text-purple-500">v4.2</span></h1>
    <div class="flex gap-2 bg-stone-200 p-1.5 rounded-2xl mt-4 max-w-sm mx-auto">
        <button onclick="switchTab('editor')" id="tab-editor" class="flex-1 py-2.5 text-[10px] uppercase rounded-xl btn-tab-active shadow-sm transition-all">Editor</button>
        <button onclick="switchTab('resultados')" id="tab-resultados" class="flex-1 py-2.5 text-[10px] uppercase rounded-xl btn-tab-inactive transition-all">Resultados</button>
    </div>
  </header>

  <main class="max-w-4xl mx-auto">
    
    <div id="view-editor" class="space-y-6">
        <section class="card p-6 space-y-4">
            <h2 id="form-title" class="text-[11px] font-black uppercase text-stone-400 mb-2">Crear / Editar Actividad</h2>
            
            <div class="space-y-2">
                <label class="text-[10px] font-black text-stone-500 uppercase px-1">Seleccionar Grados:</label>
                <div id="selector-grados" class="flex flex-wrap gap-2">
                    <button onclick="toggleGradoSel(this)" value="Primero" class="badge-grado border-2 border-stone-200 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase text-stone-400 hover:border-purple-300">Primero</button>
                    <button onclick="toggleGradoSel(this)" value="Segundo" class="badge-grado border-2 border-stone-200 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase text-stone-400 hover:border-purple-300">Segundo</button>
                    <button onclick="toggleGradoSel(this)" value="Tercero" class="badge-grado border-2 border-stone-200 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase text-stone-400 hover:border-purple-300">Tercero</button>
                    <button onclick="toggleGradoSel(this)" value="Cuarto" class="badge-grado border-2 border-stone-200 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase text-stone-400 hover:border-purple-300">Cuarto</button>
                    <button onclick="toggleGradoSel(this)" value="Quinto" class="badge-grado border-2 border-stone-200 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase text-stone-400 hover:border-purple-300">Quinto</button>
                    <button onclick="toggleGradoSel(this, true)" value="Todos" class="badge-grado border-2 border-stone-200 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase text-stone-400 hover:border-purple-300">Todos</button>
                </div>
            </div>

            <div class="mt-2">
                <label class="text-[10px] font-black text-stone-500 uppercase px-1">Asignar a estudiante en espec√≠fico (Opcional):</label>
                <select id="estudianteEspecifico" class="w-full text-xs font-bold bg-stone-50 mt-1">
                    <option value="">Todos (Grupal) - Dejar en blanco para todo el grado</option>
                </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                <input type="text" id="tituloTaller" placeholder="T√≠tulo de la actividad..." class="w-full text-xs font-bold">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black text-red-600 uppercase px-1 mb-1">Fecha y Hora de Cierre:</span>
                    <input type="datetime-local" id="fechaVencimiento" class="w-full text-xs font-bold bg-red-50 text-red-900 border-red-200">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                <select id="tipoActividad" class="w-full text-xs font-bold bg-stone-50"><option value="">Tipo...</option><option>Taller de Comprensi√≥n Lectora</option><option>Taller Evaluativo</option><option>Taller de Refuerzo</option><option>Taller de Repaso</option><option>Taller de ambientaci√≥n previa</option><option>Taller de recuperaci√≥n</option></select>
                <select id="areaConocimiento" class="w-full text-xs font-bold bg-stone-50"><option value="">√Årea...</option><option>ESPA√ëOL (LENGUAJE)</option><option>MATEMATICAS</option><option>CIENCIAS NATURALES</option><option>CIENCIAS SOCIALES</option><option>INGLES</option><option>ARTISTICA</option><option>EDUCACION FISICA</option><option>ETICA Y VALORES</option><option>RELIGION</option><option>TECNOLOGIA E INFORMATICA</option></select>
            </div>

            <textarea id="textoLectura" rows="5" placeholder="Pega el texto aqu√≠ (Opcional si usas imagen/video)..." class="w-full text-sm font-medium mt-2"></textarea>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                <input type="url" id="imagenTaller" placeholder="URL de Imagen (Opcional)" class="w-full text-xs font-bold">
                <input type="url" id="videoTaller" placeholder="URL de Video YouTube (Opcional)" class="w-full text-xs font-bold">
            </div>

            <div id="contenedorPreguntas" class="space-y-6 border-t pt-4 flex flex-col"></div>

            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                <button onclick="agregarPregunta('multiple')" class="py-3 bg-purple-50 text-purple-700 rounded-xl text-[9px] font-black uppercase border-2 border-dashed border-purple-200 hover:bg-purple-100">+ M√∫ltiple</button>
                <button onclick="agregarPregunta('verdadero_falso')" class="py-3 bg-green-50 text-green-700 rounded-xl text-[9px] font-black uppercase border-2 border-dashed border-green-200 hover:bg-green-100">+ V / F</button>
                <button onclick="agregarPregunta('abierta')" class="py-3 bg-blue-50 text-blue-700 rounded-xl text-[9px] font-black uppercase border-2 border-dashed border-blue-200 hover:bg-blue-100">+ Abierta</button>
                <button onclick="agregarPregunta('completacion')" class="py-3 bg-yellow-50 text-yellow-700 rounded-xl text-[9px] font-black uppercase border-2 border-dashed border-yellow-200 hover:bg-yellow-100">+ Completar</button>
                <button onclick="agregarPregunta('ahorcado')" class="py-3 bg-red-50 text-red-700 rounded-xl text-[9px] font-black uppercase border-2 border-dashed border-red-200 hover:bg-red-100">+ Ahorcado</button>
                <button onclick="agregarPregunta('pareados')" class="py-3 bg-indigo-50 text-indigo-700 rounded-xl text-[9px] font-black uppercase border-2 border-dashed border-indigo-200 hover:bg-indigo-100">+ Pareados</button>
            </div>

            <div class="flex gap-2 pt-4 border-t">
                <button onclick="abrirVistaPrevia()" id="btnPreview" class="flex-[1] py-4 bg-blue-50 text-blue-700 border-2 border-blue-200 rounded-2xl font-black shadow-sm uppercase text-[10px] hover:bg-blue-100 active:scale-95 transition-transform">üëÅÔ∏è Previa</button>
                <button onclick="guardarTaller('draft')" id="btnBorrador" class="flex-[1.5] py-4 bg-stone-200 text-stone-600 rounded-2xl font-black uppercase text-[10px] hover:bg-stone-300">Guardar Borrador</button>
                <button onclick="guardarTaller('published')" id="btnPublicar" class="flex-[2] py-4 bg-purple-900 text-white rounded-2xl font-black shadow-xl uppercase text-[10px] active:scale-95 transition-transform">Publicar en Escuela</button>
            </div>

        </section>

        <section class="space-y-4">
            <div class="flex gap-2 bg-stone-200 p-1.5 rounded-xl">
                <button onclick="setFiltroLista('publicados')" id="filtro-publicados" class="flex-1 py-2 text-[10px] font-black uppercase rounded-lg bg-white shadow-sm text-purple-900 transition-all">Publicados</button>
                <button onclick="setFiltroLista('borradores')" id="filtro-borradores" class="flex-1 py-2 text-[10px] font-black uppercase rounded-lg text-stone-500 hover:bg-white transition-all">Borradores</button>
                <button onclick="setFiltroLista('archivados')" id="filtro-archivados" class="flex-1 py-2 text-[10px] font-black uppercase rounded-lg text-stone-500 hover:bg-white transition-all">Archivados</button>
            </div>
            <div id="listaTalleres" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </section>
    </div>

    <div id="view-resultados" class="hidden space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-2xl border border-stone-200 shadow-sm gap-3">
            <h2 class="text-xs font-black uppercase text-stone-500">Historial de Respuestas</h2>
            <div class="flex gap-2">
                <button onclick="setFiltroResultados('activos')" id="filtro-res-activos" class="bg-purple-100 text-purple-800 text-[9px] font-black px-3 py-2 rounded-lg uppercase shadow-sm">Activos</button>
                <button onclick="setFiltroResultados('archivados')" id="filtro-res-archivados" class="bg-stone-100 text-stone-500 text-[9px] font-black px-3 py-2 rounded-lg uppercase hover:bg-stone-200">Archivados</button>
                <button onclick="descargarReportePDF()" class="bg-red-600 text-white text-[9px] font-black px-4 py-2 rounded-lg uppercase shadow-lg flex items-center gap-2 active:scale-95">üìÑ Exportar PDF</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-3 bg-white p-4 rounded-2xl border border-stone-200 shadow-sm">
            <input type="text" id="busqueda-estudiante" oninput="renderizarResultados()" placeholder="üîç Buscar Estudiante..." class="w-full text-xs font-bold bg-stone-50 border-stone-200">
            <select id="busqueda-grado" onchange="renderizarResultados()" class="w-full md:w-48 text-xs font-bold bg-stone-50 border-stone-200">
                <option value="">Todos los Grados</option>
                <option value="Primero">Primero</option>
                <option value="Segundo">Segundo</option>
                <option value="Tercero">Tercero</option>
                <option value="Cuarto">Cuarto</option>
                <option value="Quinto">Quinto</option>
            </select>
            <select id="busqueda-actividad" onchange="renderizarResultados()" class="w-full text-xs font-bold bg-stone-50 border-stone-200">
                <option value="">Todas las Actividades</option>
            </select>
        </div>
        <div id="listaResultados" class="space-y-4"></div>
    </div>
  </main>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8", authDomain: "diariodeprocesos-6f78d.firebaseapp.com", projectId: "diariodeprocesos-6f78d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let tallerEditandoId = null;

    let listaEstudiantesGlobal = [];

    function getYouTubeId(url) { if(!url) return null; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? match[2] : null; }

    function abrirVistaPrevia() {
        const titulo = document.getElementById('tituloTaller').value || "T√çTULO DE LA ACTIVIDAD";
        const texto = document.getElementById('textoLectura').value;
        const imgUrl = document.getElementById('imagenTaller').value.trim();
        const vidUrl = document.getElementById('videoTaller').value.trim();
        const tipo = document.getElementById('tipoActividad').value || "TALLER";
        const area = document.getElementById('areaConocimiento').value || "√ÅREA";
        
        let contenidoHtml = `<div style="text-align:center; margin-bottom:15px;"><span style="font-size:10px; font-weight:900; background:#475569; color:#fff; padding:5px 10px; border-radius:8px; text-transform:uppercase;">üìö ${area} | ${tipo}</span></div>`;
        contenidoHtml += `<div style="font-weight:900; color:#1b5e20; text-align:center; margin-bottom:15px; font-size:18px;">${titulo}</div>`;

        let mediaTextHtml = "";
        if(vidUrl) {
            const vidId = getYouTubeId(vidUrl);
            if(vidId) mediaTextHtml += `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${vidId}" allowfullscreen></iframe></div>`;
        }
        if(imgUrl) {
            mediaTextHtml += `<img src="${imgUrl}" style="width:100%; border-radius:12px; margin-bottom:15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">`;
        }
        if(texto) {
            const tempDiv = document.createElement('div');
            tempDiv.innerText = texto;
            mediaTextHtml += `<div style="white-space: pre-line;">${tempDiv.innerHTML}</div>`;
        }
        
        if(mediaTextHtml) {
            contenidoHtml += `<div class="lectura-texto">${mediaTextHtml}</div>`;
        }

        const divs = document.querySelectorAll('[id^="pregunta-"]');
        let qIndex = 0;
        divs.forEach(div => {
            const t = div.dataset.tipo;
            const pText = div.querySelector('.q-text').value || "Enunciado de la pregunta...";
            
            let qHtml = `<div class="pregunta-card"><div style="font-weight:800; font-size:14px; margin-bottom:10px; color:#1e293b;">${qIndex+1}. ${pText}</div>`;
            
            if(t === 'multiple') {
                qHtml += `<label class="opcion-label"><input type="radio" disabled name="pv${qIndex}" style="margin-right:8px;"> A) ${div.querySelector('.opt-a').value || 'Opci√≥n A'}</label>`;
                qHtml += `<label class="opcion-label"><input type="radio" disabled name="pv${qIndex}" style="margin-right:8px;"> B) ${div.querySelector('.opt-b').value || 'Opci√≥n B'}</label>`;
                qHtml += `<label class="opcion-label"><input type="radio" disabled name="pv${qIndex}" style="margin-right:8px;"> C) ${div.querySelector('.opt-c').value || 'Opci√≥n C'}</label>`;
                qHtml += `<label class="opcion-label"><input type="radio" disabled name="pv${qIndex}" style="margin-right:8px;"> D) ${div.querySelector('.opt-d').value || 'Opci√≥n D'}</label>`;
            } else if(t === 'verdadero_falso') {
                qHtml += `<label class="opcion-label"><input type="radio" disabled name="pv${qIndex}" style="margin-right:8px;"> Verdadero</label>`;
                qHtml += `<label class="opcion-label"><input type="radio" disabled name="pv${qIndex}" style="margin-right:8px;"> Falso</label>`;
            } else if(t === 'completacion') {
                const textoComp = div.querySelector('.comp-texto').value || "Ejemplo: El color del cielo es ___";
                let textoInLine = textoComp.replace(/_{2,}/g, `<input type="text" disabled placeholder="..." style="width: 70px; padding: 2px 5px; margin: 0 4px; border: none; border-bottom: 2px solid #1b5e20; background: #e8f5e9; text-align: center; font-weight: bold; outline: none; color: #1b5e20; border-radius: 4px 4px 0 0;">`);
                qHtml += `<div style="background:#fff; padding:15px; border-radius:10px; font-size:15px; line-height:2.2; margin-bottom:12px; border:1px dashed #cbd5e1; color:#1e293b;">${textoInLine}</div>`;
                qHtml += `<button type="button" class="preview-btn">COMPROBAR RESPUESTA</button>`;
            } else if(t === 'ahorcado') {
                const palabraOculta = div.querySelector('.ahorcado-palabra').value || "PALABRA";
                let chars = palabraOculta.split('');
                let boxes = chars.map(c => c === ' ' ? '<div style="width:15px; display:inline-block;"></div>' : `<div style="display:inline-block; width:20px; border-bottom:3px solid #1e293b; margin:0 3px; height:25px;"></div>`).join('');
                qHtml += `<div style="text-align:center; margin:15px 0;">${boxes}</div>`;
                const pistas = div.querySelector('.ahorcado-pistas').value;
                if (pistas) qHtml += `<div style="text-align:center; font-size:11px; color:#ef4444; font-weight:900; margin-bottom:10px; text-transform:uppercase;">üí° PISTAS: ${pistas}</div>`;
                qHtml += `<input type="text" disabled placeholder="Escribe la palabra oculta..." style="width:100%; padding:14px; border-radius:12px; border:1.5px solid #cbd5e1; font-size:14px; text-align:center; text-transform:uppercase; font-weight:bold; background:#f9f9f9;">`;
                qHtml += `<button type="button" class="preview-btn" style="margin-top:10px;">COMPROBAR RESPUESTA</button>`;
            } else if(t === 'pareados') {
                qHtml += `<div style="font-size:12px; color:#475569; margin-bottom:12px; font-weight:bold;">Selecciona la pareja correcta para cada elemento:</div>`;
                for(let i=0; i<4; i++) {
                    const izq = div.querySelector(`.par-izq-${i}`).value.trim();
                    const der = div.querySelector(`.par-der-${i}`).value.trim();
                    if(izq && der) {
                        qHtml += `
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                            <div style="flex:1; background:#e2e8f0; padding:10px; border-radius:10px; font-size:13px; font-weight:700; color:#1e293b;">${izq}</div>
                            <select disabled style="flex:1; padding:10px; border-radius:10px; border:1.5px solid #cbd5e1; font-size:12px; background:#f9f9f9;"><option>${der}</option></select>
                        </div>`;
                    }
                }
            } else {
                qHtml += `<textarea disabled placeholder="Escribe aqu√≠ tu respuesta de forma clara y con buena ortograf√≠a..." rows="4" style="width:100%; border:1.5px solid #cbd5e1; border-radius:12px; padding:12px; font-family:inherit; font-size:14px; background:#f9f9f9;"></textarea>`;
            }
            qHtml += `</div>`;
            contenidoHtml += qHtml;
            qIndex++;
        });

        contenidoHtml += `<button disabled class="preview-btn" style="margin-bottom:30px;">ENVIAR RESPUESTAS AL PROFESOR</button>`;

        document.getElementById('preview-body').innerHTML = contenidoHtml;
        document.getElementById('modal-preview').style.display = 'flex';
    }

    function cerrarVistaPrevia() {
        document.getElementById('modal-preview').style.display = 'none';
    }

    function switchTab(tab) {
        document.getElementById('view-editor').classList.toggle('hidden', tab !== 'editor');
        document.getElementById('view-resultados').classList.toggle('hidden', tab !== 'resultados');
        document.getElementById('tab-editor').className = tab === 'editor' ? 'flex-1 py-2.5 text-[10px] uppercase rounded-xl btn-tab-active shadow-sm' : 'flex-1 py-2.5 text-[10px] uppercase rounded-xl btn-tab-inactive';
        document.getElementById('tab-resultados').className = tab === 'resultados' ? 'flex-1 py-2.5 text-[10px] uppercase rounded-xl btn-tab-active shadow-sm' : 'flex-1 py-2.5 text-[10px] uppercase rounded-xl btn-tab-inactive';
        if(tab === 'resultados') cargarResultados();
    }

    function toggleGradoSel(btn, isTodos = false) {
        if(isTodos) {
            document.querySelectorAll('.badge-grado').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        } else {
            const btnTodos = document.querySelector('.badge-grado[value="Todos"]');
            if(btnTodos) btnTodos.classList.remove('selected');
            btn.classList.toggle('selected');
        }
    }

    function moverPreguntaArriba(btn) {
        const div = btn.closest('div[id^="pregunta-"]');
        if (div.previousElementSibling) div.parentNode.insertBefore(div, div.previousElementSibling);
    }

    function moverPreguntaAbajo(btn) {
        const div = btn.closest('div[id^="pregunta-"]');
        if (div.nextElementSibling) div.parentNode.insertBefore(div.nextElementSibling, div);
    }

    function agregarPregunta(tipo, data = null) {
      const id = Date.now() + Math.random();
      const div = document.createElement('div');
      
      let bgClass = '';
      if(tipo === 'multiple') bgClass = 'border-purple-100 bg-white';
      else if(tipo === 'abierta') bgClass = 'border-blue-100 bg-blue-50/30';
      else if(tipo === 'completacion') bgClass = 'border-yellow-100 bg-yellow-50/30';
      else if(tipo === 'ahorcado') bgClass = 'border-red-100 bg-red-50/30';
      else if(tipo === 'pareados') bgClass = 'border-indigo-100 bg-indigo-50/30';
      else bgClass = 'border-green-100 bg-green-50/30';

      div.className = `p-5 rounded-2xl border-2 shadow-sm relative ${bgClass}`;
      div.id = `pregunta-${id}`;
      div.dataset.tipo = tipo;
      
      let html = `
      <div class="absolute top-3 right-12 flex gap-1">
          <button onclick="moverPreguntaArriba(this)" class="w-6 h-6 flex items-center justify-center bg-stone-100/50 text-stone-400 rounded hover:bg-blue-100 hover:text-blue-600 transition-colors text-[10px]" title="Subir">‚ñ≤</button>
          <button onclick="moverPreguntaAbajo(this)" class="w-6 h-6 flex items-center justify-center bg-stone-100/50 text-stone-400 rounded hover:bg-blue-100 hover:text-blue-600 transition-colors text-[10px]" title="Bajar">‚ñº</button>
      </div>
      <button onclick="this.parentElement.remove()" class="absolute top-3 right-3 w-6 h-6 flex items-center justify-center bg-stone-100/50 text-stone-300 rounded hover:bg-red-100 hover:text-red-500 transition-colors text-xs" title="Eliminar">‚úï</button>
      <input type="text" value="${data?data.pregunta:''}" placeholder="${tipo==='completacion'?'Instrucci√≥n para el estudiante...':'Enunciado de la pregunta...'}" class="w-full mb-4 mt-2 text-xs font-bold q-text">`;
      
      if (tipo === 'multiple') {
        html += `<div class="space-y-2">
            <div class="flex items-center gap-2"><input type="radio" name="correcta-${id}" value="a" ${data?.correcta==='a'?'checked':(!data?'checked':'')}> <input type="text" value="${data?data.opciones?.a||'':''}" placeholder="Opci√≥n A" class="w-full text-[11px] opt-a"></div>
            <div class="flex items-center gap-2"><input type="radio" name="correcta-${id}" value="b" ${data?.correcta==='b'?'checked':''}> <input type="text" value="${data?data.opciones?.b||'':''}" placeholder="Opci√≥n B" class="w-full text-[11px] opt-b"></div>
            <div class="flex items-center gap-2"><input type="radio" name="correcta-${id}" value="c" ${data?.correcta==='c'?'checked':''}> <input type="text" value="${data?data.opciones?.c||'':''}" placeholder="Opci√≥n C" class="w-full text-[11px] opt-c"></div>
            <div class="flex items-center gap-2"><input type="radio" name="correcta-${id}" value="d" ${data?.correcta==='d'?'checked':''}> <input type="text" value="${data?data.opciones?.d||'':''}" placeholder="Opci√≥n D" class="w-full text-[11px] opt-d"></div>
        </div>`;
      } else if (tipo === 'verdadero_falso') {
        html += `<div class="flex gap-4"><label class="text-xs font-bold"><input type="radio" name="correcta-${id}" value="verdadero" ${data?.correcta==='verdadero'?'checked':(!data?'checked':'')}> Verdadero</label><label class="text-xs font-bold"><input type="radio" name="correcta-${id}" value="falso" ${data?.correcta==='falso'?'checked':''}> Falso</label></div>`;
      } else if (tipo === 'completacion') {
        html += `<div class="space-y-2">
            <textarea placeholder="Texto con espacios. Ej: La capital de Colombia es ___" class="w-full text-[11px] font-bold comp-texto">${data?data.textoConcepto||'':''}</textarea>
            <input type="text" value="${data?data.palabrasCorrectas||'':''}" placeholder="Palabras correctas separadas por coma" class="w-full text-[11px] comp-respuestas">
        </div>`;
      } else if (tipo === 'ahorcado') {
        html += `<div class="space-y-2">
            <input type="text" value="${data?data.palabraOculta||'':''}" placeholder="Palabra o frase a descubrir..." class="w-full text-[11px] font-bold ahorcado-palabra">
            <input type="text" value="${data?data.pistas||'':''}" placeholder="Letras pista iniciales separadas por coma (Opcional)" class="w-full text-[11px] ahorcado-pistas">
        </div>`;
      } else if (tipo === 'pareados') {
        html += `<div class="space-y-2">
            <p class="text-[10px] font-black text-stone-500 uppercase mt-2">Pares (Concepto - Respuesta correcta):</p>
            <div class="flex gap-2"><input type="text" value="${data&&data.pares&&data.pares[0]?data.pares[0].izq:''}" placeholder="Concepto 1" class="w-1/2 text-[11px] par-izq-0 bg-stone-50"><input type="text" value="${data&&data.pares&&data.pares[0]?data.pares[0].der:''}" placeholder="Respuesta 1" class="w-1/2 text-[11px] par-der-0 bg-stone-50"></div>
            <div class="flex gap-2"><input type="text" value="${data&&data.pares&&data.pares[1]?data.pares[1].izq:''}" placeholder="Concepto 2" class="w-1/2 text-[11px] par-izq-1 bg-stone-50"><input type="text" value="${data&&data.pares&&data.pares[1]?data.pares[1].der:''}" placeholder="Respuesta 2" class="w-1/2 text-[11px] par-der-1 bg-stone-50"></div>
            <div class="flex gap-2"><input type="text" value="${data&&data.pares&&data.pares[2]?data.pares[2].izq:''}" placeholder="Concepto 3" class="w-1/2 text-[11px] par-izq-2 bg-stone-50"><input type="text" value="${data&&data.pares&&data.pares[2]?data.pares[2].der:''}" placeholder="Respuesta 3" class="w-1/2 text-[11px] par-der-2 bg-stone-50"></div>
            <div class="flex gap-2"><input type="text" value="${data&&data.pares&&data.pares[3]?data.pares[3].izq:''}" placeholder="Concepto 4" class="w-1/2 text-[11px] par-izq-3 bg-stone-50"><input type="text" value="${data&&data.pares&&data.pares[3]?data.pares[3].der:''}" placeholder="Respuesta 4" class="w-1/2 text-[11px] par-der-3 bg-stone-50"></div>
        </div>`;
      }
      div.innerHTML = html;
      document.getElementById('contenedorPreguntas').appendChild(div);
    }

    async function guardarTaller(status) {
        const grados = Array.from(document.querySelectorAll('.badge-grado.selected')).map(b => b.getAttribute('value'));
        const titulo = document.getElementById('tituloTaller').value;
        const fechaVencimiento = document.getElementById('fechaVencimiento').value;
        const texto = document.getElementById('textoLectura').value;
        const tipo = document.getElementById('tipoActividad').value;
        const area = document.getElementById('areaConocimiento').value;
        const imgUrl = document.getElementById('imagenTaller').value.trim();
        const vidUrl = document.getElementById('videoTaller').value.trim();
        
        const estudianteEsp = document.getElementById('estudianteEspecifico').value.trim();

        const divs = document.querySelectorAll('[id^="pregunta-"]');
        let resps = [];
        divs.forEach(div => {
            const t = div.dataset.tipo;
            const qId = div.id.split('-')[1];
            const pText = div.querySelector('.q-text').value;
            if(t==='multiple') resps.push({tipo:t, pregunta:pText, opciones:{a:div.querySelector('.opt-a').value, b:div.querySelector('.opt-b').value, c:div.querySelector('.opt-c').value, d:div.querySelector('.opt-d').value}, correcta:div.querySelector(`input[name="correcta-${qId}"]:checked`).value});
            else if(t==='verdadero_falso') resps.push({tipo:t, pregunta:pText, correcta:div.querySelector(`input[name="correcta-${qId}"]:checked`).value});
            else if(t==='completacion') resps.push({tipo:t, pregunta:pText, textoConcepto:div.querySelector('.comp-texto').value, palabrasCorrectas:div.querySelector('.comp-respuestas').value});
            else if(t==='ahorcado') resps.push({tipo:t, pregunta:pText, palabraOculta:div.querySelector('.ahorcado-palabra').value, pistas:div.querySelector('.ahorcado-pistas').value});
            else if(t==='pareados') {
                let pares = [];
                for(let i=0; i<4; i++) {
                    const izq = div.querySelector(`.par-izq-${i}`).value.trim();
                    const der = div.querySelector(`.par-der-${i}`).value.trim();
                    if(izq && der) pares.push({izq, der});
                }
                resps.push({tipo:t, pregunta:pText, pares});
            }
            else resps.push({tipo:t, pregunta:pText});
        });

        const tieneDestinoValido = grados.length > 0 || estudianteEsp !== "";
        if(!tieneDestinoValido || !titulo || !tipo || !area || !fechaVencimiento) {
             return alert("Completa todos los campos principales. Selecciona un grado o un estudiante espec√≠fico, adem√°s de Fecha de Cierre, Tipo y √Årea.");
        }
        if(!texto && !imgUrl && !vidUrl) return alert("Debes incluir un texto, una imagen o un video.");

        document.getElementById('btnPublicar').disabled = true;
        document.getElementById('btnBorrador').disabled = true;

        const tallerData = { 
            titulo, contenido: texto, imageUrl: imgUrl, videoUrl: vidUrl, 
            gradoDestino: grados, tipoActividad: tipo, areaConocimiento: area, fechaVencimiento: fechaVencimiento,
            estudianteEspecifico: estudianteEsp, 
            preguntas: resps, status: status, activo: status === 'published', archived: false, 
            timestamp: Date.now(), fecha: new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' }) 
        };

        let generarAviso = false;
        if(status === 'published') {
            if(!tallerEditandoId) { generarAviso = true; } 
            else {
                const tPrevio = cacheTalleresLocal.find(x => x.id === tallerEditandoId);
                if(tPrevio && tPrevio.status === 'draft') generarAviso = true; 
            }
        }

        if(tallerEditandoId) { await db.collection("talleresLectura").doc(tallerEditandoId).update(tallerData); } 
        else { await db.collection("talleresLectura").add(tallerData); }

        if(generarAviso) {
            const fVencObj = new Date(fechaVencimiento);
            const strF = fVencObj.toLocaleString('es-CO', { weekday:'short', day:'numeric', month:'short', hour:'numeric', minute:'2-digit', hour12:true });
            let msgPrivado = estudianteEsp ? `\nüë§ Asignaci√≥n Privada` : '';
            await db.collection("tableroAvisos").add({
                mensaje: `üéÆ NUEVO TALLER\nüìç √Årea: ${area}\nüìù Trabajo: ${titulo}\n‚è≥ Cierre: ${strF}${msgPrivado}`,
                color: 'purple', scope: estudianteEsp ? 'Individual' : (grados.includes('Todos') ? 'General' : 'Grado'), 
                targetGrades: grados, targetStudentDoc: estudianteEsp ? estudianteEsp : null,
                timestamp: new Date().toISOString(), archived: false, isTallerNotice: true 
            });
        }
        location.reload();
    }

    let filtroLista = 'publicados';
    let cacheTalleresLocal = [];

    function setFiltroLista(filtro) {
        filtroLista = filtro;
        document.getElementById('filtro-publicados').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all ${filtro==='publicados'?'bg-white shadow-sm text-purple-900':'text-stone-500 hover:bg-white'}`;
        document.getElementById('filtro-borradores').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all ${filtro==='borradores'?'bg-white shadow-sm text-purple-900':'text-stone-500 hover:bg-white'}`;
        document.getElementById('filtro-archivados').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all ${filtro==='archivados'?'bg-white shadow-sm text-purple-900':'text-stone-500 hover:bg-white'}`;
        renderizarTalleres();
    }

    function cargarTalleres() {
      db.collection("talleresLectura").orderBy("timestamp", "desc").onSnapshot(snap => {
        cacheTalleresLocal = [];
        snap.forEach(doc => cacheTalleresLocal.push({id: doc.id, ...doc.data()}));
        renderizarTalleres();
      });
    }

    async function reabrirActividad(id) {
        const t = cacheTalleresLocal.find(x => x.id === id);
        if(!t) return;

        let swalOptions = '<option value="">Todos (Grupal)</option>';
        listaEstudiantesGlobal.forEach(est => {
            let isSelected = (est.documento === t.estudianteEspecifico) ? 'selected' : '';
            swalOptions += `<option value="${est.documento}" ${isSelected}>${est.nombre} - ${est.grado}</option>`;
        });

        const { value: formValues } = await Swal.fire({
            title: 'Reabrir / Extender / Reintento',
            html:
                `<div class="text-left space-y-3">
                    <label class="text-xs font-bold text-stone-600 block">Nueva Fecha de Cierre:</label>
                    <input id="swal-fecha" type="datetime-local" class="swal2-input !w-[90%] !text-sm !m-0" value="${t.fechaVencimiento || ''}">
                    <label class="text-xs font-bold text-stone-600 block mt-4">Asignar a un estudiante (Borra el intento anterior si lo hay):</label>
                    <select id="swal-estudiante" class="swal2-select !w-[90%] !text-sm !m-0">
                        ${swalOptions}
                    </select>
                </div>`,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Actualizar y Habilitar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                return [document.getElementById('swal-fecha').value, document.getElementById('swal-estudiante').value]
            }
        });

        if (formValues) {
            const nuevaFecha = formValues[0];
            const nuevoEstudianteDoc = formValues[1].trim();
            
            if(!nuevaFecha) return alert("Debes seleccionar una fecha obligatoriamente.");
            
            await db.collection("talleresLectura").doc(id).update({
                fechaVencimiento: nuevaFecha,
                estudianteEspecifico: nuevoEstudianteDoc,
                activo: true, 
                archived: false, 
                status: 'published'
            });

            if (nuevoEstudianteDoc) {
                const resultadosSnap = await db.collection("resultadosTalleres")
                    .where("idTaller", "==", id)
                    .where("documentoEstudiante", "==", nuevoEstudianteDoc)
                    .get();
                
                resultadosSnap.forEach(async (doc) => {
                    await db.collection("resultadosTalleres").doc(doc.id).delete();
                });
            }

            Swal.fire('¬°Habilitado!', 'La actividad ha sido reabierta y el intento anterior borrado (si exist√≠a).', 'success');
        }
    }

    function renderizarTalleres() {
        const lista = document.getElementById('listaTalleres');
        lista.innerHTML = "";
        
        let filtrados = cacheTalleresLocal.filter(t => {
            if (filtroLista === 'archivados') return t.archived === true;
            if (filtroLista === 'borradores') return t.status === 'draft' && !t.archived;
            return t.status === 'published' && !t.archived;
        });

        if(filtrados.length === 0) { lista.innerHTML = `<p class="col-span-2 text-center text-xs text-stone-400 font-black uppercase py-6">No hay registros en esta categor√≠a.</p>`; return; }

        filtrados.forEach(t => {
            let btnArchivar = t.archived 
                ? `<button onclick="toggleArchivar('${t.id}', false, '${t.status}')" class="text-emerald-700 text-[10px] font-black uppercase bg-emerald-100 px-3 py-1.5 rounded-lg hover:bg-emerald-200">Desarchivar</button>`
                : `<button onclick="toggleArchivar('${t.id}', true, '${t.status}')" class="text-orange-700 text-[10px] font-black uppercase bg-orange-100 px-3 py-1.5 rounded-lg hover:bg-orange-200">Archivar</button>`;
            let btnEditar = !t.archived ? `<button onclick="editarTaller('${t.id}')" class="text-blue-700 text-[10px] font-black uppercase bg-blue-100 px-3 py-1.5 rounded-lg hover:bg-blue-200">Editar</button>` : '';
            let btnReabrir = (t.status === 'published' || t.archived) ? `<button onclick="reabrirActividad('${t.id}')" class="text-indigo-700 text-[10px] font-black uppercase bg-indigo-100 px-3 py-1.5 rounded-lg hover:bg-indigo-200">Reabrir / Extender</button>` : '';

            let nombreEstudiante = t.estudianteEspecifico;
            let matchEst = listaEstudiantesGlobal.find(e => e.documento === t.estudianteEspecifico);
            if(matchEst) nombreEstudiante = matchEst.nombre;

            let badgeEstudiante = t.estudianteEspecifico ? `<span class="text-[8px] font-black bg-blue-100 px-2 py-0.5 rounded uppercase text-blue-600 ml-1">üë§ ${nombreEstudiante}</span>` : '';

            lista.innerHTML += `
              <div class="card p-5 border-l-4 ${t.status === 'draft' ? 'border-orange-400 bg-orange-50/30' : (t.archived ? 'border-stone-400 bg-stone-50' : 'border-purple-600')}">
                <div class="flex justify-between items-start mb-4">
                  <div class="flex-1 pr-2">
                      <span class="text-[8px] font-black bg-stone-200 px-2 py-0.5 rounded uppercase text-stone-600">${t.gradoDestino.length ? t.gradoDestino.join(', ') : 'Privado'}</span>
                      ${badgeEstudiante}
                      <h3 class="text-sm font-black text-stone-800 uppercase mt-1 leading-tight">${t.titulo}</h3>
                      <p class="text-[9px] font-bold text-stone-400 uppercase mt-1">${t.tipoActividad} | Cierre: ${new Date(t.fechaVencimiento).toLocaleString('es-CO', {dateStyle:'short', timeStyle:'short'})}</p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2 pt-3 border-t border-stone-200 justify-end">
                    ${btnReabrir}
                    ${btnEditar}
                    ${btnArchivar}
                    <button onclick="eliminarTaller('${t.id}')" class="text-red-700 text-[10px] font-black uppercase bg-red-100 px-3 py-1.5 rounded-lg hover:bg-red-200">Eliminar</button>
                </div>
              </div>`;
        });
    }

    async function editarTaller(id) {
        const t = cacheTalleresLocal.find(x => x.id === id);
        if(!t) return;
        tallerEditandoId = id;
        document.getElementById('form-title').innerText = "Editando: " + t.titulo;
        document.getElementById('tituloTaller').value = t.titulo;
        document.getElementById('estudianteEspecifico').value = t.estudianteEspecifico || '';
        document.getElementById('fechaVencimiento').value = t.fechaVencimiento || '';
        document.getElementById('textoLectura').value = t.contenido;
        document.getElementById('imagenTaller').value = t.imageUrl || '';
        document.getElementById('videoTaller').value = t.videoUrl || '';
        document.getElementById('tipoActividad').value = t.tipoActividad;
        document.getElementById('areaConocimiento').value = t.areaConocimiento;
        document.querySelectorAll('.badge-grado').forEach(b => { b.classList.remove('selected'); if(t.gradoDestino && t.gradoDestino.includes(b.getAttribute('value'))) b.classList.add('selected'); });
        document.getElementById('contenedorPreguntas').innerHTML = "";
        t.preguntas.forEach(p => agregarPregunta(p.tipo, p));
        document.getElementById('form-title').scrollIntoView({ behavior: 'smooth' });
    }

    async function toggleArchivar(id, isArchiving, statusActual) { await db.collection("talleresLectura").doc(id).update({ archived: isArchiving, activo: isArchiving ? false : (statusActual === 'published') }); }
    async function eliminarTaller(id) { if((await Swal.fire({title:'¬øEliminar Definitivamente?', text:'Esta acci√≥n no se puede deshacer.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'})).isConfirmed) { await db.collection("talleresLectura").doc(id).delete(); } }

    let cacheResultados = [];
    let filtroResultados = 'activos';
    let resultadosFiltrados = []; 

    function setFiltroResultados(filtro) {
        filtroResultados = filtro;
        document.getElementById('filtro-res-activos').className = `text-[9px] font-black px-3 py-2 rounded-lg uppercase transition-all ${filtro==='activos'?'bg-purple-100 text-purple-800 shadow-sm':'bg-stone-100 text-stone-500 hover:bg-stone-200'}`;
        document.getElementById('filtro-res-archivados').className = `text-[9px] font-black px-3 py-2 rounded-lg uppercase transition-all ${filtro==='archivados'?'bg-purple-100 text-purple-800 shadow-sm':'bg-stone-100 text-stone-500 hover:bg-stone-200'}`;
        renderizarResultados();
    }

    function cargarResultados() {
        db.collection("resultadosTalleres").orderBy("timestamp", "desc").onSnapshot(snap => {
            cacheResultados = [];
            snap.forEach(doc => { cacheResultados.push({id: doc.id, ...doc.data()}) });
            actualizarDropdownActividades(); 
            renderizarResultados();
        });
    }

    function actualizarDropdownActividades() {
        const select = document.getElementById('busqueda-actividad');
        if(!select) return;
        
        const valorPrevio = select.value;
        const actividadesUnicas = [...new Set(cacheResultados.map(r => r.tituloTaller))].filter(Boolean);
        
        let html = '<option value="">Todas las Actividades</option>';
        actividadesUnicas.forEach(act => { 
            html += `<option value="${act}">${act}</option>`; 
        });
        
        select.innerHTML = html;
        if(actividadesUnicas.includes(valorPrevio)) select.value = valorPrevio;
    }

    function renderizarResultados() {
        const div = document.getElementById("listaResultados");
        
        const termEstudiante = document.getElementById('busqueda-estudiante') ? document.getElementById('busqueda-estudiante').value.toLowerCase() : '';
        const termGrado = document.getElementById('busqueda-grado') ? document.getElementById('busqueda-grado').value : '';
        const termActividad = document.getElementById('busqueda-actividad') ? document.getElementById('busqueda-actividad').value : ''; 

        resultadosFiltrados = cacheResultados.filter(r => {
            const estadoMatch = filtroResultados === 'archivados' ? r.archived === true : !r.archived;
            const estudianteMatch = (r.nombreEstudiante || '').toLowerCase().includes(termEstudiante);
            const gradoMatch = termGrado === '' || r.grado === termGrado;
            const actividadMatch = termActividad === '' || r.tituloTaller === termActividad; 
            
            return estadoMatch && estudianteMatch && gradoMatch && actividadMatch;
        });
        
        div.innerHTML = resultadosFiltrados.length === 0 ? '<p class="text-center py-20 text-stone-400 text-xs uppercase font-black">Sin respuestas en esta categor√≠a o filtro</p>' : "";
        
        resultadosFiltrados.forEach(res => {
            let respuestasHtml = res.respuestas.map((r, i) => {
                let icono = r.esCorrecta ? '‚úÖ' : '‚ùå';
                if (r.tipo === 'abierta' || r.tipo === 'completacion') icono = 'üìù';
                if (r.tipo === 'ahorcado') icono = 'üéÆ';
                if (r.tipo === 'pareado_item') icono = 'üß©';
                return `<div class="p-3 bg-stone-50 rounded-xl mb-2 border border-stone-100"><p class="text-[10px] font-black text-stone-400 uppercase">P${i+1}: ${r.pregunta}</p><p class="text-xs font-bold text-stone-700">${icono} Resp: ${r.respuestaDada}</p></div>`;
            }).join("");
            
            let bloqueNotaHtml = "";
            if (res.requiereRevision) {
                bloqueNotaHtml = `<div class="flex flex-col items-end gap-1"><span class="text-[9px] font-black bg-orange-100 text-orange-700 px-2 py-1 rounded">‚ö†Ô∏è REVISAR</span><span class="text-[9px] font-bold text-stone-400">Autom√°ticas: ${res.aciertosCerrados}/${res.totalCerradas}</span><div class="flex items-center gap-1 mt-1"><input type="number" id="nota-${res.id}" placeholder="Nota..." step="0.1" min="0" max="5" class="w-16 h-8 text-center text-xs font-black border-2 border-orange-300 rounded-lg p-0 bg-white"><button onclick="calificarManual('${res.id}')" class="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-[9px] font-black shadow-md">OK</button></div></div>`;
            } else {
                let notaFinalVisual = parseFloat(res.nota) || 0;
                if (notaFinalVisual > 5 && res.totalCerradas) {
                    notaFinalVisual = (notaFinalVisual / res.totalCerradas) * 5.0;
                }
                
                bloqueNotaHtml = `<div class="text-right"><span class="text-2xl font-black ${notaFinalVisual >= 3 ? 'text-green-600' : 'text-red-600'}">${notaFinalVisual.toFixed(1)}</span><p class="text-[8px] font-black opacity-40 uppercase">Nota Final (Max 5.0)</p></div>`;
            }

            let btnArchivarRes = res.archived 
                ? `<button onclick="toggleArchivarResultado('${res.id}', false)" class="text-emerald-700 text-[10px] font-black uppercase bg-emerald-100 px-3 py-2 rounded-lg hover:bg-emerald-200">Desarchivar</button>`
                : `<button onclick="toggleArchivarResultado('${res.id}', true)" class="text-stone-700 text-[10px] font-black uppercase bg-stone-200 px-3 py-2 rounded-lg hover:bg-stone-300">Archivar</button>`;

            div.innerHTML += `
            <div class="card p-6 border ${res.requiereRevision ? 'border-orange-200 bg-orange-50/20' : 'border-stone-100'}">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-[9px] font-black text-purple-600 uppercase mb-1">${res.grado} ¬∑ ${res.tituloTaller}</p>
                        <div class="flex items-center gap-3">
                            <h3 class="font-black text-stone-800 text-base uppercase leading-tight">${res.nombreEstudiante}</h3>
                            <button onclick="document.getElementById('respuestas-${res.id}').classList.toggle('hidden')" class="bg-stone-200 text-stone-700 text-[9px] font-black px-3 py-1.5 rounded-lg hover:bg-stone-300 transition-all active:scale-95 shadow-sm">üëÅÔ∏è VISUALIZAR</button>
                        </div>
                        <p class="text-[10px] text-stone-400 font-bold uppercase mt-1">${res.fecha}</p>
                    </div>
                    ${bloqueNotaHtml}
                </div>
                
                <div id="respuestas-${res.id}" class="hidden grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 bg-stone-100 p-3 rounded-xl border border-stone-200">
                    ${respuestasHtml}
                </div>
                
                <div class="border-t border-stone-200 pt-3 flex flex-wrap gap-2 justify-end">
                    <button onclick="habilitarReintento('${res.id}')" class="text-purple-700 text-[10px] font-black uppercase bg-purple-100 px-3 py-2 rounded-lg hover:bg-purple-200">üîÑ Habilitar Reintento</button>
                    ${btnArchivarRes}
                    <button onclick="eliminarResultadoDefinitivo('${res.id}')" class="text-red-700 text-[10px] font-black uppercase bg-red-100 px-3 py-2 rounded-lg hover:bg-red-200">Eliminar Definitivo</button>
                </div>
            </div>`;
        });
    }

    async function calificarManual(docId) {
        const inputVal = document.getElementById(`nota-${docId}`).value;
        const notaDefinitiva = parseFloat(inputVal.replace(',', '.'));
        if(isNaN(notaDefinitiva) || notaDefinitiva < 0 || notaDefinitiva > 5) { return alert("Ingresa una nota v√°lida entre 0 y 5.0"); }
        await db.collection("resultadosTalleres").doc(docId).update({ nota: notaDefinitiva, requiereRevision: false });
    }

    async function habilitarReintento(docId) {
        if((await Swal.fire({title:'¬øPermitir Reintento?', text:'Se borrar√° la nota y el estudiante podr√° entrar de nuevo.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'})).isConfirmed) {
            await db.collection("resultadosTalleres").doc(docId).delete();
            Swal.fire('Habilitado', 'El estudiante ya puede resolver el taller nuevamente.', 'success');
        }
    }

    async function toggleArchivarResultado(id, isArchiving) {
        await db.collection("resultadosTalleres").doc(id).update({ archived: isArchiving });
    }

    async function eliminarResultadoDefinitivo(id) {
        if((await Swal.fire({title:'¬øEliminar Resultado?', text:'Esta acci√≥n borrar√° la nota permanentemente de la base de datos.', icon:'error', showCancelButton:true, confirmButtonText: 'S√≠, eliminar', confirmButtonColor:'#d33'})).isConfirmed) { 
            await db.collection("resultadosTalleres").doc(id).delete(); 
        }
    }

    function descargarReportePDF() {
        if(resultadosFiltrados.length === 0) return alert("No hay datos para exportar con los filtros actuales.");
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(14); doc.text("REPORTE DE ACTIVIDADES EVALUATIVAS - 2026", 10, 15);
        
        const body = resultadosFiltrados.map(r => { 
            let notaFinalPDF = parseFloat(r.nota) || 0;
            if (notaFinalPDF > 5 && r.totalCerradas) notaFinalPDF = (notaFinalPDF / r.totalCerradas) * 5.0;
            const notaCelda = r.requiereRevision ? 'Pendiente' : notaFinalPDF.toFixed(1); 
            return [r.grado, r.nombreEstudiante, r.tituloTaller, notaCelda, r.fecha]; 
        });
        
        doc.autoTable({ startY: 25, head: [['GRADO', 'ESTUDIANTE', 'TALLER', 'NOTA', 'FECHA']], body: body, headStyles: { fillColor: [107, 33, 168] } });
        doc.save("Reporte_Lectura_Oscar.pdf");
    }

    function cargarListaEstudiantes() {
        db.collection("configuracionGlobal").doc("listasEstudiantes").get().then(doc => {
            if (doc.exists) {
                const listas = doc.data();
                
                if (!listas['Quinto']) listas['Quinto'] = [];
                const pedroData = "Pedro P√©rez - 12345678";
                if (!listas['Quinto'].includes(pedroData)) {
                    listas['Quinto'].push(pedroData);
                    db.collection("configuracionGlobal").doc("listasEstudiantes").update({
                        'Quinto': firebase.firestore.FieldValue.arrayUnion(pedroData)
                    });
                }

                listaEstudiantesGlobal = [];
                for (const grado in listas) {
                    const estudiantes = listas[grado];
                    if (Array.isArray(estudiantes)) {
                        estudiantes.forEach(estudianteStr => {
                            const partes = estudianteStr.split(' - ');
                            const nombre = partes[0].trim();
                            const docIdentidad = partes.length > 1 ? partes[1].trim() : nombre;
                            listaEstudiantesGlobal.push({ nombre, documento: docIdentidad, grado });
                        });
                    }
                }
                
                listaEstudiantesGlobal.sort((a, b) => a.nombre.localeCompare(b.nombre));

                const selectEl = document.getElementById('estudianteEspecifico');
                let htmlOptions = '<option value="">Todos (Grupal) - Dejar en blanco para todo el grado</option>';
                
                listaEstudiantesGlobal.forEach(est => {
                    htmlOptions += `<option value="${est.documento}">${est.nombre} - ${est.grado}</option>`;
                });
                
                selectEl.innerHTML = htmlOptions; 
            }
        }).catch(err => console.error("Error cargando lista de estudiantes: ", err));
    }

    window.onload = () => { 
        cargarTalleres(); 
        cargarListaEstudiantes(); 
    };
  </script>
</body>
</html>
